window.onload=function(){var G=$("draw-canvas");var v=$("neighbor-canvas");var I=G.getContext("2d");var J=v.getContext("2d");var L=true;var e;var q=null;var n=null;var a,d;var k;var w={x:0,y:0,pressed:false,dragged:false};var u=null;var o={offsetX:0,offsetY:0,width:0,height:0,scale:12,padding:1};var t={pattern:"center",neighbors:[],baseRGB:[255,165,0],deviation:5,reliance:1,delay:0,initialDeviation:50,numPoints:10,size:100,hexAngle:60,};var s={relianceInput:$("reliance"),deviationInput:$("deviation"),colorInput:$("color"),delayInput:$("delay"),widthInput:$("width"),heightInput:$("height"),patternSelect:$("pattern"),initDeviationInput:$("init-deviation"),numPointsInput:$("num-points"),sizeInput:$("size"),hexAngleInput:$("hex-angle"),neighborsZoomInBtn:$("neighbors-zoom-in"),neighborsZoomOutBtn:$("neighbors-zoom-out"),neighborsCenterBtn:$("neighbors-center"),neighborsResetBtn:$("neighbors-reset"),pauseBtn:$("pause"),resetBtn:$("reset"),saveBtn:$("save-btn"),saveImg:$("save-img")};H();function H(){scaleCanvas(G,I);scaleCanvas(v,J);fitElement(G);Object.defineProperty(t,"width",{get:function(){return G.width},set:function(M){C(M,d)},});Object.defineProperty(t,"height",{get:function(){return G.height},set:function(M){C(a,M)},});linkInputToNumber(s.relianceInput,t,"reliance");linkInputToNumber(s.deviationInput,t,"deviation");linkInputToNumber(s.delayInput,t,"delay");linkInputToNumber(s.widthInput,t,"width",null,false);linkInputToNumber(s.heightInput,t,"height",null,false);linkInputToNumber(s.initDeviationInput,t,"initialDeviation");linkInputToNumber(s.numPointsInput,t,"numPoints");linkInputToNumber(s.sizeInput,t,"size");linkInputToNumber(s.hexAngleInput,t,"hexAngle");linkSelectToString(s.patternSelect,t,"pattern",g);linkColorChooserToValues(s.colorInput,t,"baseRGB");s.pauseBtn.addEventListener("click",function(){z(!L)});s.resetBtn.addEventListener("click",E);s.saveBtn.addEventListener("click",function(){s.saveImg.src=G.toDataURL()});s.neighborsZoomInBtn.addEventListener("click",function(){o.scale++;A()});s.neighborsZoomOutBtn.addEventListener("click",function(){if(o.scale>1){o.scale--;A()}});s.neighborsCenterBtn.addEventListener("click",B);s.neighborsResetBtn.addEventListener("click",j);v.addEventListener("mousedown",m);v.addEventListener("mousemove",p);v.addEventListener("mouseup",D);v.addEventListener("mouseleave",i);v.addEventListener("touchstart",h);v.addEventListener("touchmove",l);v.addEventListener("touchend",F);g();o.width=v.drawWidth;o.height=v.drawHeight;j();E();z(false)}function r(M,O,N){N=N||[0,0,0];return{x:M,y:O,r:N[0],g:N[1],b:N[2],n:0}}function E(){a=G.width;d=G.height;k=I.createImageData(a,d);var O,S,Q,U;delete q;q=new Array(d);for(Q=0;Q<d;Q++){q[Q]=new Array(a)}n=null;I.clearRect(0,0,G.drawWidth,G.drawHeight);switch(t.pattern){default:case"center":f(r(a/2,d/2,t.baseRGB));break;case"vertical":for(S=0;S<a;S++){U=r(S,0,t.baseRGB);c(U,t.initialDeviation);f(U)}break;case"random":for(O=0;O<t.numPoints;O++){U=r(Math.floor(Math.random()*a),Math.floor(Math.random()*d),t.baseRGB);c(U,t.initialDeviation);f(U)}break;case"hex":var R=t.hexAngle*Math.PI/180;var V=Math.cos(R);var P=Math.sin(R);var T=1/Math.tan(R);for(S=t.size/2;S<a+(a*T);S+=t.size){for(Q=t.size/2;Q<d/P;Q+=t.size){var M=Math.floor(Q*P);var N=Math.floor(S-Q*V);if(N>=0&&N<a&&M>=0&&M<d){U=r(N,M,t.baseRGB);c(U,t.initialDeviation);f(U)}}}break;case"distributed":var W=poissonDisk(0,0,a,d,Math.sqrt(a*d/(1.5*t.numPoints)));for(var O=0;O<W.length;O++){U=r(Math.floor(W[O].x),Math.floor(W[O].y),t.baseRGB);c(U,t.initialDeviation);f(U)}break}}function x(){var M=n;while(M){var N=M.cell;if(b(N)){N.r/=N.n;N.g/=N.n;N.b/=N.n;c(N,t.deviation);if(M.prev){M.prev.next=M.next}else{n=M.next}if(M.next){M.next.prev=M.prev}f(N)}M=M.next}if(!L){setTimeout(x,t.delay)}}function c(N,M){N.r=Math.clamp(N.r+Math.random()*M*2-M,0,255);N.g=Math.clamp(N.g+Math.random()*M*2-M,0,255);N.b=Math.clamp(N.b+Math.random()*M*2-M,0,255)}function b(M){return Math.random()<(Math.pow(M.n,t.reliance)/Math.pow(t.neighbors.length,t.reliance))}function K(){I.putImageData(k,0,0)}function f(S){var O=t.neighbors.length;while(O--){var R=t.neighbors[O];var M=R.x+S.x;var Q=R.y+S.y;if(Q>=0&&Q<d&&M>=0&&M<a){var P=q[Q][M];if(!P){P=q[Q][M]=r(M,Q);n={cell:P,next:n,prev:null};if(n.next){n.next.prev=n}}P.r+=S.r;P.g+=S.g;P.b+=S.b;P.n++}}var N=(S.y*a+S.x)*4;k.data[N+0]=S.r;k.data[N+1]=S.g;k.data[N+2]=S.b;k.data[N+3]=255}function z(M){if(M&&!L){L=M;clearInterval(e)}else{if(!M&&L){L=M;e=setInterval(K,15);x()}}s.pauseBtn.innerHTML=L?"Resume":"Pause"}function C(M,N){a=M;d=N;resizeCanvas(G,I,M,N);E()}function g(){var M=document.querySelectorAll(".optional");var N=M.length;while(N--){M[N].style.display="none"}M=document.querySelectorAll(".optional."+t.pattern);N=M.length;while(N--){M[N].style.display="table-row"}}function j(){t.neighbors=[{x:0,y:1},{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:-1},{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1}];B()}function B(){o.offsetX=(o.width/(2*o.scale))-0.5;o.offsetY=(o.height/(2*o.scale))-0.5;A()}function A(){J.clearRect(0,0,v.width,v.height);var Q=o.scale;var N=(o.offsetY-Math.ceil(o.offsetY))*Q;for(var S=Math.floor(-o.offsetY);N<o.height;S++,N+=Q){var O=(o.offsetX-Math.ceil(o.offsetX))*Q;for(var M=Math.floor(-o.offsetX);O<o.width;M++,O+=Q){if(S===0&&M===0){J.fillStyle="#00FF00";J.strokeRect(O,N,o.scale-o.padding,o.scale-o.padding)}else{if(u&&u.y==S&&u.x==M){J.fillStyle="#CCCCFF"}else{J.fillStyle="#BBBBBB"}}J.fillRect(O,N,o.scale-o.padding,o.scale-o.padding)}}var P=t.neighbors.length;while(P--){var R=t.neighbors[P];if(u&&u.x==R.x&&u.y==R.y){J.fillStyle="#666699"}else{J.fillStyle="#555555"}J.fillRect(Q*(R.x+o.offsetX),Q*(R.y+o.offsetY),o.scale-o.padding,o.scale-o.padding)}}function y(){if(!u){return}var M=t.neighbors.length;while(M--){var N=t.neighbors[M];if(N.x==u.x&&N.y==u.y){t.neighbors.splice(M,1);return}}if(u.x||u.y){t.neighbors[t.neighbors.length]=u}}function m(M){w.pressed=true}function p(M){var N=getRelativeCoord(v,M);if(w.pressed){u=null;w.dragged=true;o.offsetX+=(N.x-w.x)/o.scale;o.offsetY+=(N.y-w.y)/o.scale}else{u={x:Math.floor(N.x/o.scale-o.offsetX),y:Math.floor(N.y/o.scale-o.offsetY),}}w.x=N.x;w.y=N.y;A()}function D(M){if(w.pressed&&!w.dragged){y()}w.pressed=false;w.dragged=false;p(M)}function i(M){u=null;w.pressed=false;w.dragged=false;A()}function h(M){l(M);u={x:Math.floor(w.x/o.scale-o.offsetX),y:Math.floor(w.y/o.scale-o.offsetY),};w.pressed=true;A()}function l(M){takeTouchFocus(M);var N=getRelativeCoord(v,M);var P=(N.x-w.x);var O=(N.y-w.y);if(w.pressed&&P*P+O*O>1){u=null;w.dragged=true;o.offsetX+=P/o.scale;o.offsetY+=O/o.scale;A()}w.x=N.x;w.y=N.y}function F(M){takeTouchFocus(M);if(u){y();u=null;A()}w.pressed=false;w.dragged=false}};