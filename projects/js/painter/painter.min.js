window.onload=function(){function e(){scaleCanvas(R,T),scaleCanvas(C,L),fitElement(R),linkInputToNumber(Y.relianceInput,X,"reliance"),linkInputToNumber(Y.deviationInput,X,"deviation"),linkInputToNumber(Y.tendencyInput,X,"tendency"),linkInputToNumber(Y.delayInput,X,"delay"),linkInputToNumber(Y.widthInput,X,"width",null,!1),linkInputToNumber(Y.heightInput,X,"height",null,!1),linkInputToNumber(Y.initDeviationInput,X,"initialDeviation"),linkInputToNumber(Y.numPointsInput,X,"numPoints"),linkInputToNumber(Y.sizeInput,X,"size"),linkInputToNumber(Y.hexAngleInput,X,"hexAngle"),linkSelectToString(Y.patternSelect,X,"pattern",d),linkColorChooserToValues(Y.colorInput,X,"baseRGB"),linkColorChooserToValues(Y.goalColorInput,X,"goalRGB"),Y.pauseBtn.addEventListener("click",function(){s(!E)}),Y.resetBtn.addEventListener("click",n),Y.saveBtn.addEventListener("click",function(){Y.saveImg.src=R.toDataURL()}),Y.neighborsZoomInBtn.addEventListener("click",function(){N.scale++,f()}),Y.neighborsZoomOutBtn.addEventListener("click",function(){N.scale>1&&(N.scale--,f())}),Y.neighborsCenterBtn.addEventListener("click",h),Y.neighborsResetBtn.addEventListener("click",u),C.addEventListener("mousedown",p),C.addEventListener("mousemove",v),C.addEventListener("mouseup",y),C.addEventListener("mouseleave",b),C.addEventListener("touchstart",x),C.addEventListener("touchmove",m),C.addEventListener("touchend",I),d(),N.width=C.drawWidth,N.height=C.drawHeight,u(),n(),s(!1)}function t(e,t,n){return n=n||[0,0,0],{x:e,y:t,r:n[0],g:n[1],b:n[2],n:0}}function n(){M=R.width,k=R.height,w=T.createImageData(M,k);var e,n,o,i;for(delete z,z=new Array(k),o=0;k>o;o++)z[o]=new Array(M);switch(G=null,X.pattern){default:case"center":l(t(M/2,k/2,X.baseRGB));break;case"vertical":for(n=0;M>n;n++)i=t(n,0,X.baseRGB),a(i,X.initialDeviation),l(i);break;case"random":for(e=0;e<X.numPoints;e++)i=t(Math.floor(Math.random()*M),Math.floor(Math.random()*k),X.baseRGB),a(i,X.initialDeviation),l(i);break;case"hex":var r=X.hexAngle*Math.PI/180,s=Math.cos(r),c=Math.sin(r),d=1/Math.tan(r);for(n=X.size/2;M+M*d>n;n+=X.size)for(o=X.size/2;k/c>o;o+=X.size){var u=Math.floor(o*c),h=Math.floor(n-o*s);h>=0&&M>h&&u>=0&&k>u&&(i=t(h,u,X.baseRGB),a(i,X.initialDeviation),l(i))}}T.clearRect(0,0,M,k)}function o(){for(var e=G;e;){var t=e.cell;i(t)&&(t.r/=t.n,t.g/=t.n,t.b/=t.n,a(t,X.deviation),e.prev?e.prev.next=e.next:G=e.next,e.next&&(e.next.prev=e.prev),l(t)),e=e.next}E||setTimeout(o,X.delay)}function a(e,t){e.r=Math.clamp((e.r+X.goalRGB[0]*X.tendency)/(1+X.tendency)+Math.random()*t*2-t,0,255),e.g=Math.clamp((e.g+X.goalRGB[1]*X.tendency)/(1+X.tendency)+Math.random()*t*2-t,0,255),e.b=Math.clamp((e.b+X.goalRGB[2]*X.tendency)/(1+X.tendency)+Math.random()*t*2-t,0,255)}function i(e){return Math.random()<Math.pow(e.n,X.reliance)/Math.pow(X.neighbors.length,X.reliance)}function r(){T.putImageData(w,0,0)}function l(e){for(var n=X.neighbors.length;n--;){var o=X.neighbors[n],a=o.x+e.x,i=o.y+e.y;if(i>=0&&k>i&&a>=0&&M>a){var r=z[i][a];r||(r=z[i][a]=t(a,i),G={cell:r,next:G,prev:null},G.next&&(G.next.prev=G)),r.r+=e.r,r.g+=e.g,r.b+=e.b,r.n++}}var l=4*(e.y*M+e.x);w.data[l+0]=e.r,w.data[l+1]=e.g,w.data[l+2]=e.b,w.data[l+3]=255}function s(e){e&&!E?(E=e,clearInterval(B)):!e&&E&&(E=e,B=setInterval(r,15),o()),Y.pauseBtn.innerHTML=E?"Resume":"Pause"}function c(e,t){R.width=M=e,R.height=k=t,n()}function d(){for(var e=document.querySelectorAll(".optional"),t=e.length;t--;)e[t].style.display="none";for(e=document.querySelectorAll(".optional."+X.pattern),t=e.length;t--;)e[t].style.display="block"}function u(){X.neighbors=[{x:0,y:1},{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:-1},{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1}],h()}function h(){N.offsetX=N.width/(2*N.scale)-.5,N.offsetY=N.height/(2*N.scale)-.5,f()}function f(){L.clearRect(0,0,C.width,C.height);for(var e=N.scale,t=(N.offsetY-Math.ceil(N.offsetY))*e,n=Math.floor(-N.offsetY);t<N.height;n++,t+=e)for(var o=(N.offsetX-Math.ceil(N.offsetX))*e,a=Math.floor(-N.offsetX);o<N.width;a++,o+=e)0===n&&0===a?(L.fillStyle="#00FF00",L.strokeRect(o,t,N.scale-N.padding,N.scale-N.padding)):D&&D.y==n&&D.x==a?L.fillStyle="#CCCCFF":L.fillStyle="#BBBBBB",L.fillRect(o,t,N.scale-N.padding,N.scale-N.padding);for(var i=X.neighbors.length;i--;){var r=X.neighbors[i];D&&D.x==r.x&&D.y==r.y?L.fillStyle="#666699":L.fillStyle="#555555",L.fillRect(e*(r.x+N.offsetX),e*(r.y+N.offsetY),N.scale-N.padding,N.scale-N.padding)}}function g(){if(D){for(var e=X.neighbors.length;e--;){var t=X.neighbors[e];if(t.x==D.x&&t.y==D.y)return void X.neighbors.splice(e,1)}(D.x||D.y)&&(X.neighbors[X.neighbors.length]=D)}}function p(e){S.pressed=!0}function v(e){var t=getRelativeCoord(C,e);S.pressed?(D=null,S.dragged=!0,N.offsetX+=(t.x-S.x)/N.scale,N.offsetY+=(t.y-S.y)/N.scale):D={x:Math.floor(t.x/N.scale-N.offsetX),y:Math.floor(t.y/N.scale-N.offsetY)},S.x=t.x,S.y=t.y,f()}function y(e){S.pressed&&!S.dragged&&g(),S.pressed=!1,S.dragged=!1,v(e)}function b(e){D=null,S.pressed=!1,S.dragged=!1,f()}function x(e){m(e),D={x:Math.floor(S.x/N.scale-N.offsetX),y:Math.floor(S.y/N.scale-N.offsetY)},S.pressed=!0,f()}function m(e){takeTouchFocus(e);var t=getRelativeCoord(C,e),n=t.x-S.x,o=t.y-S.y;S.pressed&&n*n+o*o>1&&(D=null,S.dragged=!0,N.offsetX+=n/N.scale,N.offsetY+=o/N.scale,f()),S.x=t.x,S.y=t.y}function I(e){takeTouchFocus(e),D&&(g(),D=null,f()),S.pressed=!1,S.dragged=!1}var B,M,k,w,R=$("draw-canvas"),C=$("neighbor-canvas"),T=R.getContext("2d"),L=C.getContext("2d"),E=!0,z=null,G=null,S={x:0,y:0,pressed:!1,dragged:!1},D=null,N={offsetX:0,offsetY:0,width:0,height:0,scale:12,padding:1},X={get width(){return R.width},get height(){return R.height},set width(e){c(e,k)},set height(e){c(M,e)},pattern:"center",neighbors:[],baseRGB:[255,165,0],goalRGB:[255,100,100],deviation:5,reliance:1,tendency:.002,delay:0,initialDeviation:50,numPoints:10,size:100,hexAngle:60},Y={relianceInput:$("reliance"),deviationInput:$("deviation"),colorInput:$("color"),goalColorInput:$("goal-color"),tendencyInput:$("tendency"),delayInput:$("delay"),widthInput:$("width"),heightInput:$("height"),patternSelect:$("pattern"),initDeviationInput:$("init-deviation"),numPointsInput:$("num-points"),sizeInput:$("size"),hexAngleInput:$("hex-angle"),neighborsZoomInBtn:$("neighbors-zoom-in"),neighborsZoomOutBtn:$("neighbors-zoom-out"),neighborsCenterBtn:$("neighbors-center"),neighborsResetBtn:$("neighbors-reset"),pauseBtn:$("pause"),resetBtn:$("reset"),saveBtn:$("save-btn"),saveImg:$("save-img")};e()};