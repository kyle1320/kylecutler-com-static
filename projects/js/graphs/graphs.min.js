window.onload=function(){function e(){scaleCanvas(p,L);var e=scaleCanvas(E,F),o=$("canvases");fitElement(o,o.clientWidth,o.clientHeight,function(e){p.style.width=E.style.width=o.style.width,p.style.height=E.style.height=o.style.height});var s=(p.drawWidth,p.drawHeight,f(p.drawWidth,p.drawHeight,4));m=s.nodes,v=s.edges,loadFiles(["shader.vert","shader.frag"],function(n){var o=getGLProgram(F,n[0],n[1]);F.useProgram(o),y=F.getAttribLocation(o,"position");for(var t=0;16>t;t++)A.edges[t]=F.getUniformLocation(o,"edges["+t+"]");A.nEdges=F.getUniformLocation(o,"num_edges"),A.order=F.getUniformLocation(o,"order"),A.range=F.getUniformLocation(o,"range"),A.highlight=F.getUniformLocation(o,"highlight"),A.modulo=F.getUniformLocation(o,"modulo"),A.scale=F.getUniformLocation(o,"scale"),F.uniform1f(A.scale,e),R=!0,i()},function(e){console.log("Couldn't find file: "+e)}),k=F.createBuffer(),F.bindBuffer(F.ARRAY_BUFFER,k),F.bufferData(F.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),F.STATIC_DRAW),F.viewport(0,0,F.drawingBufferWidth,F.drawingBufferHeight),F.clearColor(0,0,0,0),T.setAll(!0),b=null,w=null,C=null,x={x:0,y:0,inside:!1},linkInputToNumber(I.orderinput,P,"order",i),linkInputToNumber(I.rangeinput,P,"range",i),linkCheckboxToBoolean(I.sncheck,P,"showNodes",t),linkCheckboxToBoolean(I.secheck,P,"showEdges",t),linkCheckboxToBoolean(I.bgcheck,P,"background",i),linkCheckboxToBoolean(I.edcheck,P,"edgeDists"),linkCheckboxToBoolean(I.hlcheck,P,"highlight",i),linkCheckboxToBoolean(I.mocheck,P,"modulo",i),linkCheckboxToBoolean(I.upcheck,P,"constantUpdates"),p.addEventListener("mousedown",d),p.addEventListener("mouseup",h),p.addEventListener("mouseenter",g),p.addEventListener("mouseleave",u),p.addEventListener("mousemove",l),p.addEventListener("touchstart",d),p.addEventListener("touchend",u),p.addEventListener("touchmove",l),window.addEventListener("keydown",c),n()}function n(){var e=P.background&&(T.background||(T.edgesChanged||T.deselection)&&(P.constantUpdates||!T.mouseMotion&&!T.mousePress)||T.orderChanged),n=T.graph||T.nodesChanged||T.edgesChanged,t=P.edgeDists&&(T.mouseMotion||T.mouseEnter||T.mouseLeave);if(T.setAll(!1),e&&R&&v.length<=16?B||(B=!0,window.requestAnimFrame(o)):P.background||F.clear(F.COLOR_BUFFER_BIT),(n||t)&&(L.clearRect(0,0,p.drawWidth,p.drawHeight),P.showEdges&&v.forEach(function(e){L.beginPath(),L.moveTo(e.a.x,e.a.y),L.lineTo(e.b.x,e.b.y),L.closePath(),L.strokeStyle=e.color,L.lineWidth=P.edgeWidth,L.stroke()}),P.showNodes&&m.forEach(function(e){L.beginPath(),L.arc(e.x,e.y,P.nodeSize,0,2*Math.PI),L.closePath(),L.fillStyle="#000000",L.strokeStyle="#FFFFFF",L.lineWidth=1,L.fill(),L.stroke()}),P.edgeDists&&x.inside))for(var i=0;i<v.length;i++){var s=v[i].distance(x);L.beginPath(),L.arc(x.x,x.y,s,0,2*Math.PI),L.closePath(),L.strokeStyle=v[i].color,L.lineWidth=1,L.stroke()}}function o(){F.clear(F.COLOR_BUFFER_BIT),F.uniform1i(A.nEdges,v.length),F.uniform1i(A.order,P.order),F.uniform1f(A.range,P.range),F.uniform1f(A.highlight,P.highlight?1:0),F.uniform1f(A.modulo,P.modulo?1:0);for(var e=0;e<v.length;e++){var n=v[e];F.uniform4fv(A.edges[e],new Float32Array([n.a.x,p.drawHeight-n.a.y,n.b.x,p.drawHeight-n.b.y]))}F.bindBuffer(F.ARRAY_BUFFER,k),F.enableVertexAttribArray(y),F.vertexAttribPointer(y,2,F.FLOAT,!1,0,0),F.drawArrays(F.TRIANGLES,0,6),B=!1}function t(){T.graph=!0,n()}function i(){T.background=!0,n()}function s(){for(var e,n=Number.POSITIVE_INFINITY,o=0;o<m.length;o++)e=m[o].distance(x),n>e&&(n=e,b=m[o])}function r(e,n){this.x=e,this.y=n}function a(e,n,o){this.a=e,this.b=n,this.color=o}function d(e){takeTouchFocus(e);var o=getRelativeCoord(p,e);if(x.x=o.x,x.y=o.y,b.nearby(x,P.nodeSize)&&(w=b,T.selection=!0),e.ctrlKey||e.metaKey)if(null===w)b=new r(x.x,x.y,10),m.push(b),T.nodesChanged=!0;else{var t=new r(x.x,x.y,10);C=new a(t,w,randomColor()),w=t,v.push(C),T.edgesChanged=!0}T.mousePress=!0,n()}function h(e){takeTouchFocus(e),null!==C&&(b.nearby(x,P.nodeSize)?(C.a=b,T.edgesChanged=!0):(m.push(w),b=w,T.nodesChanged=!0),C=null),null!==w&&(T.deselection=!0),T.mouseRelease=!0,w=null,n()}function l(e){takeTouchFocus(e);var o=getRelativeCoord(p,e);x.x=o.x,x.y=o.y,s(),null!==w&&(w.move(x),T.nodesChanged=!0,T.edgesChanged=!0),T.mouseMotion=!0,n()}function c(e){if(81==e.keyCode)if(b.nearby(x,P.nodeSize)){var o=m.indexOf(b);m.splice(o,1),T.nodesChanged=!0;for(var t=0;t<v.length;t++){var i=v[t];(i.a==b||i.b==b)&&(v.splice(t,1),T.edgesChanged=!0,t--)}s()}else for(var t=0;t<v.length;t++){var r=v[t].distance(x);if(4>r){v.splice(t,1),T.edgesChanged=!0;break}}n()}function g(e){x.inside=!0,T.mouseEnter=!0,n()}function u(e){x.inside=!1,T.mouseLeave=!0,h(e)}function f(e,n,o){for(var t=[],i=[],s=0;o>s;s++){var d=new r(e/2+Math.sin(2*Math.PI*s/o)*(e/4),n/2+Math.cos(2*Math.PI*s/o)*(n/4));t[s]=d;for(var h=0;s>h;h++)i[i.length]=new a(d,t[h],randomColor())}return{nodes:t,edges:i}}var m,v,y,k,b,w,C,x,p=$("draw-canvas"),E=$("gl-canvas"),L=p.getContext("2d"),F=getGL(E,{preserveDrawingBuffer:!0}),T={mouseMotion:!1,mousePress:!1,mouseRelease:!1,mouseEnter:!1,mouseLeave:!1,nodesChanged:!1,edgesChanged:!1,orderChanged:!1,selection:!1,deselection:!1,graph:!1,background:!1,setAll:function(e){this.mouseMotion=this.mousePress=this.mouseRelease=this.mouseEnter=this.mouseLeave=this.nodesChanged=this.edgesChanged=this.orderChanged=this.selection=this.deselection=this.graph=this.background=e}},A={edges:[],nEdges:null,order:null,range:null,highlight:null,modulo:null,scale:null},R=!1,B=!1,P={nodeSize:10,edgeWidth:1,order:4,range:250,showNodes:!0,showEdges:!0,background:!0,edgeDists:!1,highlight:!0,modulo:!1,constantUpdates:!0},I={orderinput:$("orderinput"),rangeinput:$("rangeinput"),sncheck:$("shownodes"),secheck:$("showedges"),bgcheck:$("background"),edcheck:$("edgedists"),hlcheck:$("highlight"),mocheck:$("modulo"),upcheck:$("updates")};e(),r.prototype.distance=function(e){var n=e.x-this.x,o=e.y-this.y;return Math.sqrt(n*n+o*o)},r.prototype.nearby=function(e,n){var o=e.x-this.x,t=e.y-this.y;return n*n>o*o+t*t},r.prototype.move=function(e){this.x=e.x,this.y=e.y},a.prototype.distance=function(e){var n=this.b.x-this.a.x,o=this.b.y-this.a.y,t=n*n+o*o,i=e.x-this.a.x,s=e.y-this.a.y,r=e.x-this.b.x,a=e.y-this.b.y,d=n*i+o*s;return 0>=d?Math.sqrt(i*i+s*s):d>=t?Math.sqrt(r*r+a*a):Math.sqrt(i*i+s*s-d*d/t)}};
