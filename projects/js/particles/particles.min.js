window.onload=function(){function t(){scaleCanvas(g,I),scaleCanvas(k,w);var t=$("canvases");fitElement(t,t.clientWidth,t.clientHeight,function(e){g.style.width=k.style.width=t.style.width,g.style.height=k.style.height=t.style.height}),m=g.drawWidth,f=g.drawHeight,linkInputToNumber(C.gravInput,B,"gravity"),linkInputToNumber(C.decayInput,B,"decay"),linkInputToNumber(C.groupSizeInput,B,"groupSize"),linkInputToNumber(C.groupRadiusInput,B,"groupRadius"),linkInputToNumber(C.mouseDensityInput,B,"mouseDensity"),linkInputToNumber(C.particleRadiusInput,B,"particleRadius"),linkInputToNumber(C.particleDensityInput,B,"particleDensity"),linkCheckboxToBoolean(C.fpcheck,B,"fixedParticles"),linkCheckboxToBoolean(C.tpcheck,B,"traceNew"),linkCheckboxToBoolean(C.bocheck,B,"bounce"),linkCheckboxToBoolean(C.trcheck,B,"trace"),C.pauseBtn.addEventListener("click",function(){c(!T)}),C.clearBtn.addEventListener("click",o),C.clearTraceBtn.addEventListener("click",r),C.saveBtn.addEventListener("click",function(){C.saveImg.src=k.toDataURL()}),g.addEventListener("mousedown",u),g.addEventListener("mousemove",d),g.addEventListener("mouseup",h),g.addEventListener("mouseleave",h),window.addEventListener("keydown",p),g.addEventListener("touchstart",l),g.addEventListener("touchmove",y),g.addEventListener("touchend",v),i(g.drawWidth/2,g.drawHeight/2),c(!1)}function e(t,e,i,n,a,s,o){this.x=t,this.y=e,this.radius=i,this.mass=i*i*Math.PI*n,this.color=a,this.trace=s||!1,this.fixed=o||!1}function i(t,e){b=b.concat(n(t,e))}function n(t,i){void 0===t&&(t=Math.random()*m),void 0===i&&(i=Math.random()*f);for(var n=randomColor(),a=[],s=0;s<B.groupSize;s++){var o=B.groupRadius*s/B.groupSize,r=t+o*Math.cos(s),c=i+o*Math.sin(s);a[a.length]=new e(r,c,B.particleRadius,B.particleDensity,n,B.traceNew,B.fixedParticles)}return a}function a(){function t(t,e){t.beginPath(),t.arc(e.x,e.y,e.radius,0,2*Math.PI),t.closePath(),t.fillStyle=e.color,t.fill()}I.clearRect(0,0,g.drawWidth,g.drawHeight),B.trace||r();for(var e=0;e<b.length;e++)t(I,b[e]),I.strokeStyle="#000000",I.lineWidth=.5,I.stroke(),B.trace&&b[e].trace&&t(w,b[e]);if(R&&t(I,R),E)for(var e=0;e<E.length;e++)t(I,E[e]);L&&(I.beginPath(),I.moveTo(L.ox,L.oy),I.lineTo(L.ox+L.x,L.oy+L.y),I.closePath(),I.strokeStyle="#00FF00",I.stroke())}function s(t){for(var e=0;e<b.length;e++){for(var i=e+1;i<b.length;i++)b[e].attract(b[i],t);R&&b[e].attract(R,t),b[e].update(t)}a()}function o(){b=[],a()}function r(){w.clearRect(0,0,k.drawWidth,k.drawHeight)}function c(t){t&&!T?clearInterval(x):T&&(x=setInterval(function(){s(.015)},15)),T=t,C.pauseBtn.innerHTML=t?"Resume":"Pause"}function u(t){var i=getRelativeCoord(g,t);t.ctrlKey||t.metaKey?(E=n(i.x,i.y),L={ox:i.x,oy:i.y,x:0,y:0}):R=new e(i.x,i.y,1,B.mouseDensity,"#FFFF00",!1,!1),a()}function h(t){E&&(E.forEach(function(t){t.vx=L.x,t.vy=L.y}),L=null,b=b.concat(E),E=null),R=null,a()}function d(t){var i=getRelativeCoord(g,t);L&&(L.x=i.x-L.ox,L.y=i.y-L.oy),R?(R.x=i.x,R.y=i.y):R=new e(i.x,i.y,1,B.mouseDensity,"#FFFF00",!1,!1),a()}function l(t){takeTouchFocus(t);var i=getRelativeCoord(g,t);F?(E=n(i.x,i.y),L={ox:i.x,oy:i.y,x:0,y:0},a()):(R=new e(i.x,i.y,1,B.mouseDensity,"#FFFF00",!1,!1),F=!0,setTimeout(function(){F=!1},400))}function y(t){takeTouchFocus(t),d(t)}function v(t){takeTouchFocus(t),h(t)}function p(t){switch(t.keyCode){case 13:o()}}var x,m,f,g=$("draw-canvas"),k=$("trace-canvas"),I=g.getContext("2d"),w=k.getContext("2d"),b=[],T=!0,F=!1,R=null,E=null,L=null,B={bounce:!0,trace:!0,gravity:20,decay:0,groupSize:40,groupRadius:8,mouseDensity:50,particleRadius:1,particleDensity:1,fixedParticles:!1,traceNew:!0},C={gravInput:$("gravity"),decayInput:$("decay"),groupSizeInput:$("group-size"),groupRadiusInput:$("group-radius"),mouseDensityInput:$("mouse-density"),particleRadiusInput:$("particle-radius"),particleDensityInput:$("particle-density"),fpcheck:$("fixed-particles"),tpcheck:$("trace-particles"),bocheck:$("bounce"),trcheck:$("trace"),pauseBtn:$("pause"),clearBtn:$("clear"),clearTraceBtn:$("clear-trace"),saveBtn:$("save-btn"),saveImg:$("save-img")};t(),e.prototype.vx=0,e.prototype.vy=0,e.prototype.mx=0,e.prototype.my=0,e.prototype.update=function(t){this.vx=this.mx+this.vx*(1-B.decay),this.vy=this.my+this.vy*(1-B.decay),B.bounce&&((this.x<this.radius&&this.vx<0||this.x>m-this.radius&&this.vx>0)&&(this.vx=-this.vx),(this.y<this.radius&&this.vy<0||this.y>f-this.radius&&this.vy>0)&&(this.vy=-this.vy)),this.fixed||(this.x+=this.vx*t,this.y+=this.vy*t),this.mx=0,this.my=0},e.prototype.attract=function(t,e){var i=this.x-t.x,n=this.y-t.y,a=i*i+n*n;if(0!==a){var s=this.radius+t.radius,o=s*s;o>=a&&(a=o);var r=B.gravity*e/a,c=i*r,u=n*r;t.mx+=c*this.mass,t.my+=u*this.mass,this.mx-=c*t.mass,this.my-=u*t.mass}}};