window.onload=function(){var c=$("draw-canvas");var n=$("trace-canvas");var h=c.getContext("2d");var f=n.getContext("2d");var z=[];var A=true;var a;var D=false;var u=null;var E=null;var B=null;var t,q;var j={bounce:true,trace:true,gravity:20,decay:0,groupSize:40,groupRadius:8,mouseDensity:50,particleRadius:1,particleDensity:1,fixedParticles:false,traceNew:true};var g={gravInput:$("gravity"),decayInput:$("decay"),groupSizeInput:$("group-size"),groupRadiusInput:$("group-radius"),mouseDensityInput:$("mouse-density"),particleRadiusInput:$("particle-radius"),particleDensityInput:$("particle-density"),fpcheck:$("fixed-particles"),tpcheck:$("trace-particles"),bocheck:$("bounce"),trcheck:$("trace"),pauseBtn:$("pause"),clearBtn:$("clear"),clearTraceBtn:$("clear-trace"),saveBtn:$("save-btn"),saveImg:$("save-img")};v();function v(){scaleCanvas(c,h);scaleCanvas(n,f);var F=$("canvases");fitElement(F,F.clientWidth,F.clientHeight,function(G){c.style.width=n.style.width=F.style.width;c.style.height=n.style.height=F.style.height});t=c.drawWidth;q=c.drawHeight;linkInputToNumber(g.gravInput,j,"gravity");linkInputToNumber(g.decayInput,j,"decay");linkInputToNumber(g.groupSizeInput,j,"groupSize");linkInputToNumber(g.groupRadiusInput,j,"groupRadius");linkInputToNumber(g.mouseDensityInput,j,"mouseDensity");linkInputToNumber(g.particleRadiusInput,j,"particleRadius");linkInputToNumber(g.particleDensityInput,j,"particleDensity");linkCheckboxToBoolean(g.fpcheck,j,"fixedParticles");linkCheckboxToBoolean(g.tpcheck,j,"traceNew");linkCheckboxToBoolean(g.bocheck,j,"bounce");linkCheckboxToBoolean(g.trcheck,j,"trace");g.pauseBtn.addEventListener("click",function(){o(!A)});g.clearBtn.addEventListener("click",s);g.clearTraceBtn.addEventListener("click",e);g.saveBtn.addEventListener("click",function(){g.saveImg.src=n.toDataURL()});c.addEventListener("mousedown",C);c.addEventListener("mousemove",b);c.addEventListener("mouseup",y);c.addEventListener("mouseleave",y);window.addEventListener("keydown",p);c.addEventListener("touchstart",r);c.addEventListener("touchmove",x);c.addEventListener("touchend",d);k(c.drawWidth/2,c.drawHeight/2);o(false)}function w(F,L,H,J,K,I,G){this.x=F;this.y=L;this.radius=H;this.mass=H*H*Math.PI*J;this.color=K;this.trace=I||false;this.fixed=G||false}w.prototype.vx=0;w.prototype.vy=0;w.prototype.mx=0;w.prototype.my=0;w.prototype.update=function(F){this.vx=this.mx+this.vx*(1-j.decay);this.vy=this.my+this.vy*(1-j.decay);if(j.bounce){if((this.x<this.radius&&this.vx<0)||(this.x>t-this.radius&&this.vx>0)){this.vx=-this.vx}if((this.y<this.radius&&this.vy<0)||(this.y>q-this.radius&&this.vy>0)){this.vy=-this.vy}}if(!this.fixed){this.x+=this.vx*F;this.y+=this.vy*F}this.mx=0;this.my=0};w.prototype.attract=function(H,I){var S=this.x-H.x;var R=this.y-H.y;var P=S*S+R*R;if(P===0){return}var J=this.radius+H.radius;var O=J*J;if(P<=O){P=O}var Q=P*P;var N=Q*Q;var M=2500000;var L=2500;var K=((L*Q-M)/N)*I+(this.mass*H.mass*j.gravity*I/P);var G=S*K;var F=R*K;H.mx+=G/H.mass;H.my+=F/H.mass;this.mx-=G/this.mass;this.my-=F/this.mass};function k(F,G){z=z.concat(i(F,G))}function i(F,M){if(F===undefined){F=Math.random()*t}if(M===undefined){M=Math.random()*q}var G=randomColor();var K=[];for(var J=0;J<j.groupSize;J++){var L=j.groupRadius*J/j.groupSize;var I=F+L*Math.cos(J);var H=M+L*Math.sin(J);K[K.length]=new w(I,H,j.particleRadius,j.particleDensity,G,j.traceNew,j.fixedParticles)}return K}function m(){h.clearRect(0,0,c.drawWidth,c.drawHeight);if(!j.trace){e()}function G(H,I){H.beginPath();H.arc(I.x,I.y,I.radius,0,2*Math.PI);H.closePath();H.fillStyle=I.color;H.fill()}for(var F=0;F<z.length;F++){G(h,z[F]);h.strokeStyle="#000000";h.lineWidth=0.5;h.stroke();if(j.trace&&z[F].trace){G(f,z[F])}}if(u){G(h,u)}if(E){for(var F=0;F<E.length;F++){G(h,E[F])}}if(B){h.beginPath();h.moveTo(B.ox,B.oy);h.lineTo(B.ox+B.x,B.oy+B.y);h.closePath();h.strokeStyle="#00FF00";h.stroke()}}function l(H){for(var G=0;G<z.length;G++){for(var F=G+1;F<z.length;F++){z[G].attract(z[F],H)}if(u){z[G].attract(u,H)}z[G].update(H)}m()}function s(){z=[];m()}function e(){f.clearRect(0,0,n.drawWidth,n.drawHeight)}function o(F){if(F&&!A){clearInterval(a)}else{if(A){a=setInterval(function(){l(0.015)},15)}}A=F;g.pauseBtn.innerHTML=F?"Resume":"Pause"}function C(F){var G=getRelativeCoord(c,F);if(F.ctrlKey||F.metaKey){E=i(G.x,G.y);B={ox:G.x,oy:G.y,x:0,y:0}}else{u=new w(G.x,G.y,1,j.mouseDensity,"#FFFF00",false,false)}m()}function y(F){if(E){E.forEach(function(G){G.vx=B.x;G.vy=B.y});B=null;z=z.concat(E);E=null}u=null;m()}function b(F){var G=getRelativeCoord(c,F);if(B){B.x=G.x-B.ox;B.y=G.y-B.oy}if(u){u.x=G.x;u.y=G.y}m()}function r(F){takeTouchFocus(F);var G=getRelativeCoord(c,F);if(D){E=i(G.x,G.y);B={ox:G.x,oy:G.y,x:0,y:0};m()}else{u=new w(G.x,G.y,1,j.mouseDensity,"#FFFF00",false,false);D=true;setTimeout(function(){D=false},400)}}function x(F){takeTouchFocus(F);b(F)}function d(F){takeTouchFocus(F);y(F)}function p(F){switch(F.keyCode){case 13:s();break}}};