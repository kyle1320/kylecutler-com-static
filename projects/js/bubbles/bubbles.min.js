window.onload=function(){var a=$("draw-canvas");var d=a.getContext("2d");var t=true;var n;var p;var s;var f;var l;var o;var h;var q;var k;var i;var e={width:3000,height:3000,samples:30,padding:12,min_r:6,max_r:300,maxlevel:-1,inactivity:100,pattern:"alternate",bgcolor:null,maincolor:null,};var c={pauseBtn:$("pause"),resetBtn:$("reset"),saveBtn:$("save-btn"),saveImg:$("save-img"),width:$("width"),height:$("height"),samples:$("samples"),padding:$("padding"),min_r:$("min-rad"),max_r:$("max-rad"),maxlevel:$("max-level"),bgcolor:$("bg-color"),pattern:$("pattern"),};var g={status:$("status"),level:$("level"),points:$("points"),progress:$("progress"),};function r(){scaleCanvas(a,d);fitElement(a);c.pauseBtn.addEventListener("click",function(){m(!t)});c.resetBtn.addEventListener("click",u);c.saveBtn.addEventListener("click",function(){c.saveImg.src=a.toDataURL()});linkInputToNumber(c.width,e,"width",v,false);linkInputToNumber(c.height,e,"height",v,false);linkInputToNumber(c.samples,e,"samples",u,false);linkInputToNumber(c.padding,e,"padding",u,false);linkInputToNumber(c.min_r,e,"min_r",u,false);linkInputToNumber(c.max_r,e,"max_r",u,false);linkInputToNumber(c.maxlevel,e,"maxlevel",u,false);linkColorChooserToHexString(c.bgcolor,e,"bgcolor",u);linkSelectToString(c.pattern,e,"pattern",u);v();m(false)}function v(){resizeCanvas(a,d,e.width,e.height,false);u()}function u(){if(e.bgcolor){d.fillStyle=e.bgcolor;d.fillRect(0,0,a.drawWidth,a.drawHeight)}else{d.clearRect(0,0,a.drawWidth,a.drawHeight)}n=new QuadTree(0,0,a.drawWidth,a.drawHeight);p=0;s=0;f=1;l=2*e.max_r+e.padding;o=0;h=new Array(e.inactivity*10);q=0;k=0;i=0;g.status.innerHTML="Running";g.level.innerHTML=f}function b(){if(e.pattern=="alternate"){if(bestp%2){if(e.bgcolor){d.fillStyle=e.bgcolor}else{d.globalCompositeOperation="destination-out"}}else{if(e.maincolor){d.fillStyle=e.maincolor}else{d.fillStyle=randomColor()}}}else{if(e.pattern=="rainbow"){d.fillStyle=getSaturatedColor(bestp/6)}}}function j(){if(p<e.inactivity){var E=-Infinity,A,y;for(var M=0;M<e.samples;M++){var K=Math.random()*a.drawWidth;var J=Math.random()*a.drawHeight;var z=0;var B=n.inRegion(K-l,J-l,K+l,J+l);var L=Infinity;var D=Infinity;for(var N=0;N<B.length;N++){var I=K-B[N].x;var H=J-B[N].y;var w=Math.sqrt(I*I+H*H)-B[N].r;var O=Math.abs(w);if(w<0&&B[N].r<D){z=B[N].p+1;D=B[N].r}if(O<L){L=O}}if(z==f-1&&L>E){E=L;A=K;y=J;bestp=z}}if(E>e.min_r+e.padding){d.beginPath();d.arc(A,y,Math.min(e.max_r,E-e.padding),0,2*Math.PI);d.closePath();b();d.fill();d.globalCompositeOperation="source-over";var F={x:A,y:y,r:Math.min(e.max_r,E-e.padding),p:bestp,color:randomColor()};if(F.r>o){o=F.r}n.insert(F);p=0;g.points.innerHTML=(++s)}else{p++}var C=h[q];h[q]=(p?1:0);if(C){k-=C}k+=h[q];q=(q+1)%h.length;var G=k/h.length;i=Math.clamp(Math.floor(130*Math.sqrt(G)/Math.sqrt(26-25*G)),i,99);g.progress.innerHTML=i+"%"}else{if(f!=e.maxlevel&&o>0){f++;p=0;l=o;o=0;h=new Array(1000);q=0;k=0;i=0;g.status.innerHTML="Running";g.level.innerHTML=f}else{g.status.innerHTML="Done";g.progress.innerHTML="100%"}}if(!t){setTimeout(j,0)}}function m(w){if(w&&!t){t=w}else{if(!w&&t){t=w;j()}}c.pauseBtn.innerHTML=t?"Resume":"Pause"}r()};