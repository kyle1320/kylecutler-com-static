window.onload=function(){var a=$("draw-canvas");var d=a.getContext("2d");var t=true;var n;var p;var s;var f;var l;var o;var h;var q;var k;var i;var e={samples:30,padding:4,min_rad:2,max_rad:100,maxlevel:-1,inactivity:100,pattern:"alternate",bgcolor:null,};var c={pauseBtn:$("pause"),resetBtn:$("reset"),saveBtn:$("save-btn"),saveImg:$("save-img"),width:$("width"),height:$("height"),samples:$("samples"),padding:$("padding"),min_rad:$("min-rad"),max_rad:$("max-rad"),maxlevel:$("max-level"),bgcolor:$("bg-color"),pattern:$("pattern"),};var g={status:$("status"),level:$("level"),points:$("points"),progress:$("progress"),};function r(){scaleCanvas(a,d);fitElement(a);Object.defineProperty(e,"width",{get:function(){return a.width},set:function(x){setSize(x,a.height)},});Object.defineProperty(e,"height",{get:function(){return a.height},set:function(w){setSize(a.width,w)},});c.pauseBtn.addEventListener("click",function(){m(!t)});c.resetBtn.addEventListener("click",u);c.saveBtn.addEventListener("click",function(){c.saveImg.src=a.toDataURL()});linkInputToNumber(c.width,e,"width",v,false);linkInputToNumber(c.height,e,"height",v,false);linkInputToNumber(c.samples,e,"samples",u,false);linkInputToNumber(c.padding,e,"padding",u,false);linkInputToNumber(c.min_rad,e,"min_rad",u,false);linkInputToNumber(c.max_rad,e,"max_rad",u,false);linkInputToNumber(c.maxlevel,e,"maxlevel",u,false);linkColorChooserToHexString(c.bgcolor,e,"bgcolor",u);linkSelectToString(c.pattern,e,"pattern",u);u();m(false)}function v(x,w){resizeCanvas(a,d,x,w,false);u()}function u(){if(e.bgcolor){d.fillStyle=e.bgcolor;d.fillRect(0,0,a.drawWidth,a.drawHeight)}else{d.clearRect(0,0,a.drawWidth,a.drawHeight)}n=new QuadTree(0,0,a.drawWidth,a.drawHeight);p=0;s=0;f=1;l=2*e.max_rad+e.padding;o=0;h=new Array(e.inactivity*10);q=0;k=0;i=0;g.status.innerHTML="Running";g.level.innerHTML=f;g.points.innerHTML=s;g.progress.innerHTML=i+"%"}function b(){if(e.pattern=="alternate"){if(f%2){d.fillStyle=randomColor()}else{if(e.bgcolor){d.fillStyle=e.bgcolor}else{d.globalCompositeOperation="destination-out"}}}else{if(e.pattern=="rainbow"){d.fillStyle=getSaturatedColor((f-1)/6)}}}function j(){if(p<e.inactivity){var D=-Infinity,z,w,H;for(var O=0;O<e.samples;O++){var M=Math.random()*a.drawWidth;var L=Math.random()*a.drawHeight;var y=0;var A=n.inRegion(M-l,L-l,M+l,L+l);var K=Infinity;var C=Infinity;for(var P=0;P<A.length;P++){var J=M-A[P].x;var I=L-A[P].y;var N=Math.sqrt(J*J+I*I)-A[P].r;var E=Math.abs(N);if(N<0&&A[P].r<C){y=A[P].p+1;C=A[P].r}if(E<K){K=E}}if(y==f-1&&K>D){D=K;z=M;w=L;H=y}}if(D>e.min_rad+e.padding){var F={x:z,y:w,r:Math.min(e.max_rad,D-e.padding),p:H,color:randomColor()};d.beginPath();d.arc(F.x,F.y,F.r,0,2*Math.PI);d.closePath();b();d.fill();d.globalCompositeOperation="source-over";n.insert(F);if(F.r>o){o=F.r}p=0;g.points.innerHTML=(++s)}else{p++}var B=h[q];h[q]=(p?1:0);if(B){k-=B}k+=h[q];q=(q+1)%h.length;var G=k/h.length;i=Math.clamp(Math.floor(130*Math.sqrt(G)/Math.sqrt(26-25*G)),i,99);g.progress.innerHTML=i+"%"}else{if(f!=e.maxlevel&&o>0){f++;p=0;l=o;o=0;h=new Array(1000);q=0;k=0;i=0;g.level.innerHTML=f}else{g.status.innerHTML="Done";g.progress.innerHTML="100%"}}if(!t){setTimeout(j,0)}}function m(w){if(w&&!t){t=w}else{if(!w&&t){t=w;j()}}c.pauseBtn.innerHTML=t?"Resume":"Pause"}r()};