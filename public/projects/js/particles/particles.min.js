"use strict";window.onload=function(){function t(t,e,i,n,a,s,o){this.x=t,this.y=e,this.radius=i,this.mass=i*i*Math.PI*n,this.color=a,this.trace=s||!1,this.fixed=o||!1}function e(t,e){w=w.concat(i(t,e))}function i(e,i){void 0===e&&(e=Math.random()*x),void 0===i&&(i=Math.random()*m);for(var n=randomColor(),a=[],s=0;s<B.groupSize;s++){var o=B.groupRadius*s/B.groupSize,r=e+o*Math.cos(s),c=i+o*Math.sin(s);a[a.length]=new t(r,c,B.particleRadius,B.particleDensity,n,B.traceNew,B.fixedParticles)}return a}function n(){function t(t,e){t.beginPath(),t.arc(e.x,e.y,e.radius,0,2*Math.PI),t.closePath(),t.fillStyle=e.color,t.fill()}k.clearRect(0,0,f.drawWidth,f.drawHeight),B.trace||o();for(var e=0;e<w.length;e++)t(k,w[e]),k.strokeStyle="#000000",k.lineWidth=.5,k.stroke(),B.trace&&w[e].trace&&t(I,w[e]);if(R&&t(k,R),E)for(var e=0;e<E.length;e++)t(k,E[e]);L&&(k.beginPath(),k.moveTo(L.ox,L.oy),k.lineTo(L.ox+L.x,L.oy+L.y),k.closePath(),k.strokeStyle="#00FF00",k.stroke())}function a(t){for(var e=0;e<w.length;e++){for(var i=e+1;i<w.length;i++)w[e].attract(w[i],t);R&&w[e].attract(R,t),w[e].update(t)}n()}function s(){w=[],n()}function o(){I.clearRect(0,0,g.drawWidth,g.drawHeight)}function r(t){t&&!b?clearInterval(p):b&&(p=setInterval(function(){a(.015)},15)),b=t,C.pauseBtn.innerHTML=t?"Resume":"Pause"}function c(e){var a=getRelativeCoord(f,e);e.ctrlKey||e.metaKey?(E=i(a.x,a.y),L={ox:a.x,oy:a.y,x:0,y:0}):R=new t(a.x,a.y,1,B.mouseDensity,"#FFFF00",!1,!1),n()}function u(t){E&&(E.forEach(function(t){t.vx=L.x,t.vy=L.y}),L=null,w=w.concat(E),E=null),R=null,n()}function h(t){var e=getRelativeCoord(f,t);L&&(L.x=e.x-L.ox,L.y=e.y-L.oy),R&&(R.x=e.x,R.y=e.y),n()}function d(e){takeTouchFocus(e);var a=getRelativeCoord(f,e);T?(E=i(a.x,a.y),L={ox:a.x,oy:a.y,x:0,y:0},n()):(R=new t(a.x,a.y,1,B.mouseDensity,"#FFFF00",!1,!1),T=!0,setTimeout(function(){T=!1},400))}function l(t){takeTouchFocus(t),h(t)}function y(t){takeTouchFocus(t),u(t)}function v(t){switch(t.keyCode){case 13:s()}}var p,x,m,f=$("draw-canvas"),g=$("trace-canvas"),k=f.getContext("2d"),I=g.getContext("2d"),w=[],b=!0,T=!1,R=null,E=null,L=null,B={bounce:!0,trace:!0,gravity:20,decay:0,groupSize:40,groupRadius:8,mouseDensity:50,particleRadius:1,particleDensity:1,fixedParticles:!1,traceNew:!0},C={gravInput:$("gravity"),decayInput:$("decay"),groupSizeInput:$("group-size"),groupRadiusInput:$("group-radius"),mouseDensityInput:$("mouse-density"),particleRadiusInput:$("particle-radius"),particleDensityInput:$("particle-density"),fpcheck:$("fixed-particles"),tpcheck:$("trace-particles"),bocheck:$("bounce"),trcheck:$("trace"),pauseBtn:$("pause"),clearBtn:$("clear"),clearTraceBtn:$("clear-trace"),saveBtn:$("save-btn"),saveImg:$("save-img")};!function(){scaleCanvas(f,k),scaleCanvas(g,I);var t=$("canvases");fitElement(t,t.clientWidth,t.clientHeight,function(e){f.style.width=g.style.width=t.style.width,f.style.height=g.style.height=t.style.height}),x=f.drawWidth,m=f.drawHeight,linkInputToNumber(C.gravInput,B,"gravity"),linkInputToNumber(C.decayInput,B,"decay"),linkInputToNumber(C.groupSizeInput,B,"groupSize"),linkInputToNumber(C.groupRadiusInput,B,"groupRadius"),linkInputToNumber(C.mouseDensityInput,B,"mouseDensity"),linkInputToNumber(C.particleRadiusInput,B,"particleRadius"),linkInputToNumber(C.particleDensityInput,B,"particleDensity"),linkCheckboxToBoolean(C.fpcheck,B,"fixedParticles"),linkCheckboxToBoolean(C.tpcheck,B,"traceNew"),linkCheckboxToBoolean(C.bocheck,B,"bounce"),linkCheckboxToBoolean(C.trcheck,B,"trace"),C.pauseBtn.addEventListener("click",function(){r(!b)}),C.clearBtn.addEventListener("click",s),C.clearTraceBtn.addEventListener("click",o),C.saveBtn.addEventListener("click",function(){C.saveImg.src=g.toDataURL()}),f.addEventListener("mousedown",c),f.addEventListener("mousemove",h),f.addEventListener("mouseup",u),f.addEventListener("mouseleave",u),window.addEventListener("keydown",v),f.addEventListener("touchstart",d),f.addEventListener("touchmove",l),f.addEventListener("touchend",y),e(f.drawWidth/2,f.drawHeight/2),r(!1)}(),t.prototype.vx=0,t.prototype.vy=0,t.prototype.mx=0,t.prototype.my=0,t.prototype.update=function(t){this.vx=this.mx+this.vx*(1-B.decay),this.vy=this.my+this.vy*(1-B.decay),B.bounce&&((this.x<this.radius&&this.vx<0||this.x>x-this.radius&&this.vx>0)&&(this.vx=-this.vx),(this.y<this.radius&&this.vy<0||this.y>m-this.radius&&this.vy>0)&&(this.vy=-this.vy)),this.fixed||(this.x+=this.vx*t,this.y+=this.vy*t),this.mx=0,this.my=0},t.prototype.attract=function(t,e){var i=this.x-t.x,n=this.y-t.y,a=i*i+n*n;if(0!==a){var s=this.radius+t.radius,o=s*s;a<=o&&(a=o);var r=B.gravity*e/a,c=i*r,u=n*r;t.mx+=c*this.mass,t.my+=u*this.mass,this.mx-=c*t.mass,this.my-=u*t.mass}}};