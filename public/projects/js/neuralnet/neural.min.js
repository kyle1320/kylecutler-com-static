"use strict";function normRand(){return(Math.random()+Math.random()+Math.random()+Math.random()+Math.random()+Math.random()-3)/3}function NeuralNode(t,e,i){this.inputs=t,this.value=i,this.use=1,this.bias=void 0!==e?e:2*Math.random()-1}function NeuralEdge(t,e,i){this.input=t,this.weight=void 0!==e?e:2*Math.random()-1}function NeuralNet(t,e,i,s){this.inputs=Array(t),i>0&&(e=e.slice(0),e[e.length]=i),this.layers=Array(e.length),this.n_inputs=t,this.layer_sizes=e,this.fitness=0;var n;for(n=0;n<t;n++)this.inputs[n]=new NeuralNode([]);var n,a,r,h,o,l=t,u=this.inputs;for(n=0;n<e.length;n++){for(o=e[n],layer=this.layers[n]=Array(o),a=0;a<o;a++){for(h=[],r=0;r<l;r++)h[r]=new NeuralEdge(u[r],s);layer[a]=new NeuralNode(h)}l=o,u=layer}this.outputs=u}function NeuralSim(t,e,i,s,n,a){this.population=t,this.generation=Array(t),this.activity=i,this.gen_num=0,this.n_gens=e,this.bestnet=null;for(var r=0;r<t;r++)this.generation[r]=new NeuralNet(s,n,a)}NeuralNode.prototype.update=function(){for(var t,e=0,i=0;i<this.inputs.length;++i)t=this.inputs[i],e+=t.input.value*t.weight;e+=this.bias;var s=1/(1+Math.exp(-8*e));if(this.value){var n=Math.abs(s-this.value);this.use+=n,this.use*=.99}this.value=s},NeuralNode.prototype.mutate=function(){this.bias+=normRand()},NeuralNode.prototype.copy=function(t){this.bias=t.bias},NeuralNode.prototype.equals=function(t){return Math.abs(this.bias-t.bias)<.1},NeuralEdge.prototype.mutate=function(){this.weight+=normRand()},NeuralEdge.prototype.copy=function(t){this.weight=t.weight},NeuralEdge.prototype.equals=function(t){return Math.abs(this.weight-t.weight)<.1},NeuralNet.prototype.update=function(){var t,e,i;for(t=0;t<this.layers.length;t++)for(i=this.layers[t].length,e=0;e<i;e++)this.layers[t][e].update()},NeuralNet.prototype.input=function(){for(var t=Math.min(arguments.length,this.inputs.length),e=0;e<t;e++)this.inputs[e].value=arguments[e];this.update()},NeuralNet.prototype.output=function(t){return this.outputs[t].value},NeuralNet.prototype.breed=function(t,e){e||(e=new NeuralNet(this.n_inputs,this.layer_sizes,0,0));var i,s,n,a,r,h,o,l;if(this==t)l=1;else{var u=0,p=0;for(i=0;i<this.layers.length;i++)for(r=this.layers[i],s=0;s<r.length;s++)for(h=r[s],a=h.inputs.length,p++,h.equals(t.layers[i][s])&&u++,n=0;n<a;n++)o=h.inputs[n],p++,o.equals(t.layers[i][s].inputs[n])&&u++;l=(1+p)/(1+p-u)}for(i=0;i<e.layers.length;i++)for(r=e.layers[i],s=0;s<r.length;s++)for(h=r[s],a=h.inputs.length,Math.random()<.5?h.copy(this.layers[i][s]):h.copy(t.layers[i][s]),Math.random()<options.mutation_rate*l&&h.mutate(),n=0;n<a;n++)o=h.inputs[n],Math.random()<.5?o.copy(this.layers[i][s].inputs[n]):o.copy(t.layers[i][s].inputs[n]),Math.random()<options.mutation_rate*l&&o.mutate();return e},NeuralNet.prototype.draw=function(t,e){var i,s,n,a,r,h,o=[],l=.8/this.inputs.length,u=1/(this.layers.length+1),p=[];for(l=Math.min(l,.8*u),a=0;a<this.inputs.length;a++)o.push({x:.5*u,y:(a+.5)/this.inputs.length,color:getSaturatedColor(.8*this.inputs[a].value),use:this.inputs[a].use});for(a=0;a<this.layers.length;a++)for(i=this.layers[a],l=Math.min(l,.8/i.length),r=0;r<i.length;r++)for(s=i[r],o.push({x:u*(a+1.5),y:(r+.5)/i.length,color:getSaturatedColor(.8*s.value),use:s.use}),h=0;h<s.inputs.length;h++)n=s.inputs[h],0==a?p.push({x1:u*(a+.5),y1:(h+.5)/this.inputs.length,x2:u*(a+1.5),y2:(r+.5)/i.length,weight:Math.abs(n.weight)}):p.push({x1:u*(a+.5),y1:(h+.5)/this.layers[a-1].length,x2:u*(a+1.5),y2:(r+.5)/i.length,weight:Math.abs(n.weight)});for(l/=2,e.clearRect(0,0,t.drawWidth,t.drawHeight),a=0;a<p.length;a++)e.beginPath(),e.moveTo(p[a].x1*t.drawWidth,p[a].y1*t.drawHeight),e.lineTo(p[a].x2*t.drawWidth,p[a].y2*t.drawHeight),e.strokeStyle="#000000",e.globalAlpha=p[a].weight,e.stroke(),e.globalAlpha=1;for(a=0;a<o.length;a++)e.beginPath(),e.arc(o[a].x*t.drawWidth,o[a].y*t.drawHeight,l*t.drawWidth,0,2*Math.PI),e.globalAlpha=o[a].use,e.fillStyle=o[a].color,e.fill(),e.strokeStyle="#000000",e.stroke(),e.globalAlpha=1},NeuralSim.prototype.advance=function(){if(!(this.gen_num>=this.n_gens)){for(var t=0;t<this.population;t++)this.activity(this.generation[t]);this.generation.sort(function(t,e){return t.fitness>e.fitness?-1:t.fitness<e.fitness?1:0});var e=Math.ceil(this.population*options.breed_percent),i=Math.ceil(this.population*options.top_percent),s=this.generation.slice(0,e);if(this.bestnet=s[0],this.bestfit=s[0].fitness,this.worstfit=this.generation[this.generation.length-1].fitness,!(++this.gen_num>=this.n_gens)){this.generation=[];for(var t=0;t<i;)this.generation[t]=s[t],this.generation[t].fitness=0,t++;for(var n=t;n<this.population;n++)this.generation[n]=s[Math.floor(Math.random()*i)].breed(s[Math.floor(Math.random()*e)])}}};