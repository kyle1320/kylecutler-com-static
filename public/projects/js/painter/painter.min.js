"use strict";window.onload=function(){function e(e,t,n){return n=n||[0,0,0],{x:e,y:t,r:n[0],g:n[1],b:n[2],n:0}}function t(){M=w.width,B=w.height,k=L.createImageData(M,B);var t,n,a,o;for(T=new Array(B),a=0;a<B;a++)T[a]=new Array(M);switch(z=null,L.clearRect(0,0,w.drawWidth,w.drawHeight),X.pattern){default:case"center":r(e(M/2,B/2,X.baseRGB));break;case"vertical":for(n=0;n<M;n++)o=e(n,0,X.baseRGB),i(o,X.initialDeviation),r(o);break;case"random":for(t=0;t<X.numPoints;t++)o=e(Math.floor(Math.random()*M),Math.floor(Math.random()*B),X.baseRGB),i(o,X.initialDeviation),r(o);break;case"hex":var s=X.hexAngle*Math.PI/180,l=Math.cos(s),c=Math.sin(s),d=1/Math.tan(s);for(n=X.size/2;n<M+M*d;n+=X.size)for(a=X.size/2;a<B/c;a+=X.size){var u=Math.floor(a*c),h=Math.floor(n-a*l);h>=0&&h<M&&u>=0&&u<B&&(o=e(h,u,X.baseRGB),i(o,X.initialDeviation),r(o))}break;case"distributed":for(var f=poissonDisk(0,0,M,B,Math.sqrt(M*B/(1.5*X.numPoints))),t=0;t<f.length;t++)o=e(Math.floor(f[t].x),Math.floor(f[t].y),X.baseRGB),i(o,X.initialDeviation),r(o)}}function n(){for(var e=z;e;){var t=e.cell;a(t)&&(t.r/=t.n,t.g/=t.n,t.b/=t.n,i(t,X.deviation),e.prev?e.prev.next=e.next:z=e.next,e.next&&(e.next.prev=e.prev),r(t)),e=e.next}E||setTimeout(n,X.delay)}function i(e,t){e.r=Math.clamp(e.r+Math.random()*t*2-t,0,255),e.g=Math.clamp(e.g+Math.random()*t*2-t,0,255),e.b=Math.clamp(e.b+Math.random()*t*2-t,0,255)}function a(e){return Math.random()<Math.pow(e.n,X.reliance)/Math.pow(X.neighbors.length,X.reliance)}function o(){L.putImageData(k,0,0)}function r(t){for(var n=X.neighbors.length;n--;){var i=X.neighbors[n],a=i.x+t.x,o=i.y+t.y;if(o>=0&&o<B&&a>=0&&a<M){var r=T[o][a];r||(r=T[o][a]=e(a,o),z={cell:r,next:z,prev:null},z.next&&(z.next.prev=z)),r.r+=t.r,r.g+=t.g,r.b+=t.b,r.n++}}var s=4*(t.y*M+t.x);k.data[s+0]=t.r,k.data[s+1]=t.g,k.data[s+2]=t.b,k.data[s+3]=255}function s(e){e&&!E?(E=e,clearInterval(I)):!e&&E&&(E=e,I=setInterval(o,15),n()),Y.pauseBtn.innerHTML=E?"Resume":"Pause"}function l(e,n){M=e,B=n,resizeCanvas(w,L,e,n),t()}function c(){for(var e=document.querySelectorAll(".optional"),t=e.length;t--;)e[t].style.display="none";for(e=document.querySelectorAll(".optional."+X.pattern),t=e.length;t--;)e[t].style.display="table-row"}function d(){X.neighbors=[{x:0,y:1},{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:-1},{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1}],u()}function u(){P.offsetX=P.width/(2*P.scale)-.5,P.offsetY=P.height/(2*P.scale)-.5,h()}function h(){C.clearRect(0,0,R.width,R.height);for(var e=P.scale,t=(P.offsetY-Math.ceil(P.offsetY))*e,n=Math.floor(-P.offsetY);t<P.height;n++,t+=e)for(var i=(P.offsetX-Math.ceil(P.offsetX))*e,a=Math.floor(-P.offsetX);i<P.width;a++,i+=e)0===n&&0===a?(C.fillStyle="#00FF00",C.strokeRect(i,t,P.scale-P.padding,P.scale-P.padding)):S&&S.y==n&&S.x==a?C.fillStyle="#CCCCFF":C.fillStyle="#BBBBBB",C.fillRect(i,t,P.scale-P.padding,P.scale-P.padding);for(var o=X.neighbors.length;o--;){var r=X.neighbors[o];S&&S.x==r.x&&S.y==r.y?C.fillStyle="#666699":C.fillStyle="#555555",C.fillRect(e*(r.x+P.offsetX),e*(r.y+P.offsetY),P.scale-P.padding,P.scale-P.padding)}}function f(){if(S){for(var e=X.neighbors.length;e--;){var t=X.neighbors[e];if(t.x==S.x&&t.y==S.y)return void X.neighbors.splice(e,1)}(S.x||S.y)&&(X.neighbors[X.neighbors.length]=S)}}function g(e){D.pressed=!0}function p(e){var t=getRelativeCoord(R,e);D.pressed?(S=null,D.dragged=!0,P.offsetX+=(t.x-D.x)/P.scale,P.offsetY+=(t.y-D.y)/P.scale):S={x:Math.floor(t.x/P.scale-P.offsetX),y:Math.floor(t.y/P.scale-P.offsetY)},D.x=t.x,D.y=t.y,h()}function v(e){D.pressed&&!D.dragged&&f(),D.pressed=!1,D.dragged=!1,p(e)}function b(e){S=null,D.pressed=!1,D.dragged=!1,h()}function y(e){x(e),S={x:Math.floor(D.x/P.scale-P.offsetX),y:Math.floor(D.y/P.scale-P.offsetY)},D.pressed=!0,h()}function x(e){takeTouchFocus(e);var t=getRelativeCoord(R,e),n=t.x-D.x,i=t.y-D.y;D.pressed&&n*n+i*i>1&&(S=null,D.dragged=!0,P.offsetX+=n/P.scale,P.offsetY+=i/P.scale,h()),D.x=t.x,D.y=t.y}function m(e){takeTouchFocus(e),S&&(f(),S=null,h()),D.pressed=!1,D.dragged=!1}var I,M,B,k,w=$("draw-canvas"),R=$("neighbor-canvas"),L=w.getContext("2d"),C=R.getContext("2d"),E=!0,T=null,z=null,D={x:0,y:0,pressed:!1,dragged:!1},S=null,P={offsetX:0,offsetY:0,width:0,height:0,scale:12,padding:1},X={pattern:"center",neighbors:[],baseRGB:[255,165,0],deviation:5,reliance:1,delay:0,initialDeviation:50,numPoints:10,size:100,hexAngle:60},Y={relianceInput:$("reliance"),deviationInput:$("deviation"),colorInput:$("color"),delayInput:$("delay"),widthInput:$("width"),heightInput:$("height"),patternSelect:$("pattern"),initDeviationInput:$("init-deviation"),numPointsInput:$("num-points"),sizeInput:$("size"),hexAngleInput:$("hex-angle"),neighborsZoomInBtn:$("neighbors-zoom-in"),neighborsZoomOutBtn:$("neighbors-zoom-out"),neighborsCenterBtn:$("neighbors-center"),neighborsResetBtn:$("neighbors-reset"),pauseBtn:$("pause"),resetBtn:$("reset"),saveBtn:$("save-btn"),saveImg:$("save-img")};!function(){scaleCanvas(w,L),scaleCanvas(R,C),fitElement(w),Object.defineProperty(X,"width",{get:function(){return w.width},set:function(e){l(e,B)}}),Object.defineProperty(X,"height",{get:function(){return w.height},set:function(e){l(M,e)}}),linkInputToNumber(Y.relianceInput,X,"reliance"),linkInputToNumber(Y.deviationInput,X,"deviation"),linkInputToNumber(Y.delayInput,X,"delay"),linkInputToNumber(Y.widthInput,X,"width",null,!1),linkInputToNumber(Y.heightInput,X,"height",null,!1),linkInputToNumber(Y.initDeviationInput,X,"initialDeviation"),linkInputToNumber(Y.numPointsInput,X,"numPoints"),linkInputToNumber(Y.sizeInput,X,"size"),linkInputToNumber(Y.hexAngleInput,X,"hexAngle"),linkSelectToString(Y.patternSelect,X,"pattern",c),linkColorChooserToValues(Y.colorInput,X,"baseRGB"),Y.pauseBtn.addEventListener("click",function(){s(!E)}),Y.resetBtn.addEventListener("click",t),Y.saveBtn.addEventListener("click",function(){Y.saveImg.src=w.toDataURL()}),Y.neighborsZoomInBtn.addEventListener("click",function(){P.scale++,h()}),Y.neighborsZoomOutBtn.addEventListener("click",function(){P.scale>1&&(P.scale--,h())}),Y.neighborsCenterBtn.addEventListener("click",u),Y.neighborsResetBtn.addEventListener("click",d),R.addEventListener("mousedown",g),R.addEventListener("mousemove",p),R.addEventListener("mouseup",v),R.addEventListener("mouseleave",b),R.addEventListener("touchstart",y),R.addEventListener("touchmove",x),R.addEventListener("touchend",m),c(),P.width=R.drawWidth,P.height=R.drawHeight,d(),t(),s(!1)}()};